{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://github.com/iblsoft/swimdemo/schema/taf.json",
    "title": "MET-SWIM AMQP CP1 Message - TAF",
    "type": "object",
    "additionalProperties": false,
    "properties": {
        "address": { "type": "string", "enum": ["weather.aviation.taf"] },
        "priority": { "type": "integer", "minimum": 0, "maximum": 9 },
        "subject": { "type": "string", "const": "weather.aviation.taf" },
        "content-type": { "type": "string", "const": "application/xml" },
        "content-encoding": { "type": "string", "enum": ["gzip", "identity"] },
        "absolute-expiry-time": { "type": "integer", "minimum": 0 },
        "creation-time": { "type": "integer", "minimum": 0 },
        "conformsTo": { "type": "string", "format": "uri" },

        "properties.issue_datetime": {
            "$ref": "#/$defs/rfc3339",
            "x-iwxxm": {
                "source": "iwxxm",
                "xpath": "//iwxxm:issueTime/gml:TimeInstant/gml:timePosition",
                "notes": "Issue/publication time of the TAF"
            }
        },
        "properties.start_datetime": {
            "$ref": "#/$defs/rfc3339",
            "x-iwxxm": {
                "source": "iwxxm",
                "xpath": "//iwxxm:validPeriod/gml:TimePeriod/gml:beginPosition",
                "notes": "Start of validity period"
            }
        },
        "properties.end_datetime": {
            "$ref": "#/$defs/rfc3339",
            "x-iwxxm": {
                "source": "iwxxm",
                "xpath": "//iwxxm:validPeriod/gml:TimePeriod/gml:endPosition",
                "notes": "End of validity period"
            }
        },
        "properties.datetime": { "$ref": "#/$defs/rfc3339" },

        "properties.icao_location_identifier": {
            "type": "string",
            "pattern": "^[A-Z0-9]{4}$",
            "x-iwxxm": {
                "source": "iwxxm",
                "xpath": "//iwxxm:aerodrome/aixm:AirportHeliport//aixm:locationIndicatorICAO",
                "notes": "Aerodrome ICAO code"
            }
        },
        "properties.icao_location_type": {
            "type": "string",
            "const": "AD",
            "x-iwxxm": {
                "source": "iwxxm",
                "xpath": "",
                "notes": "Constant 'AD' because TAF is for an aerodrome"
            }
        },
        "properties.report_status": {
            "type": "string",
            "enum": ["NORMAL", "AMENDMENT", "CORRECTION"],
            "x-iwxxm": {
                "source": "iwxxm",
                "xpath": "//@reportStatus",
                "notes": "TAF report status"
            }
        },
        "geometry.type": {
            "type": "string",
            "enum": ["Point"],
            "x-iwxxm": {
                "xpath": "//aixm:ARP/aixm:ElevatedPoint/gml:pos",
                "notes": "Split gml:pos 'lat lon' into two doubles"
            }
        },
        "geometry.coordinates.latitude": {
            "type": "number",
            "minimum": -90,
            "maximum": 90
        },
        "geometry.coordinates.longitude": {
            "type": "number",
            "minimum": -180,
            "maximum": 180
        }
    },
    "required": [
        "subject",
        "content-type",
        "properties.issue_datetime",
        "properties.start_datetime",
        "properties.end_datetime",
        "properties.icao_location_identifier",
        "properties.icao_location_type",
        "properties.report_status"
    ],
    "optional": [
        "geometry.type",
        "geometry.coordinates.latitude",
        "geometry.coordinates.longitude"
    ],
    "allOf": [
        {
            "if": { "required": ["address"] },
            "then": {
                "properties": { "subject": { "const": { "$data": "1/address" } } }
            }
        }
    ],
    "$defs": {
        "rfc3339": {
            "type": "string",
            "format": "date-time",
            "pattern": "Z$",
            "description": "RFC3339 UTC (must end with 'Z')."
        }
    }
}
